<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>浏览器渲染原理 | Happyblog</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="基于 vuepress 的简易博客平台">
    
    <link rel="preload" href="/vuepress-blog/assets/css/0.styles.631b7830.css" as="style"><link rel="preload" href="/vuepress-blog/assets/js/app.f8677ea4.js" as="script"><link rel="preload" href="/vuepress-blog/assets/js/2.32f56e5c.js" as="script"><link rel="preload" href="/vuepress-blog/assets/js/1.a930a345.js" as="script"><link rel="preload" href="/vuepress-blog/assets/js/11.8f72b06d.js" as="script"><link rel="prefetch" href="/vuepress-blog/assets/js/10.ab76fc9b.js"><link rel="prefetch" href="/vuepress-blog/assets/js/12.428f6f98.js"><link rel="prefetch" href="/vuepress-blog/assets/js/13.eb47b2b6.js"><link rel="prefetch" href="/vuepress-blog/assets/js/14.7257e695.js"><link rel="prefetch" href="/vuepress-blog/assets/js/15.bd1b03c3.js"><link rel="prefetch" href="/vuepress-blog/assets/js/16.7a561afc.js"><link rel="prefetch" href="/vuepress-blog/assets/js/17.cd516f79.js"><link rel="prefetch" href="/vuepress-blog/assets/js/18.42e9f2b1.js"><link rel="prefetch" href="/vuepress-blog/assets/js/19.4958156f.js"><link rel="prefetch" href="/vuepress-blog/assets/js/20.cd1f9a1c.js"><link rel="prefetch" href="/vuepress-blog/assets/js/21.e4fea2d1.js"><link rel="prefetch" href="/vuepress-blog/assets/js/22.0919633c.js"><link rel="prefetch" href="/vuepress-blog/assets/js/23.331c698f.js"><link rel="prefetch" href="/vuepress-blog/assets/js/24.5874fb5a.js"><link rel="prefetch" href="/vuepress-blog/assets/js/25.e56a5813.js"><link rel="prefetch" href="/vuepress-blog/assets/js/26.7e912fb0.js"><link rel="prefetch" href="/vuepress-blog/assets/js/27.aa11be6f.js"><link rel="prefetch" href="/vuepress-blog/assets/js/28.b8505e46.js"><link rel="prefetch" href="/vuepress-blog/assets/js/29.155d9866.js"><link rel="prefetch" href="/vuepress-blog/assets/js/3.d7d8640a.js"><link rel="prefetch" href="/vuepress-blog/assets/js/30.80297b92.js"><link rel="prefetch" href="/vuepress-blog/assets/js/31.977ccbdd.js"><link rel="prefetch" href="/vuepress-blog/assets/js/32.767609f9.js"><link rel="prefetch" href="/vuepress-blog/assets/js/33.44891ea8.js"><link rel="prefetch" href="/vuepress-blog/assets/js/34.f516ab0b.js"><link rel="prefetch" href="/vuepress-blog/assets/js/35.151a5daf.js"><link rel="prefetch" href="/vuepress-blog/assets/js/36.ece446f9.js"><link rel="prefetch" href="/vuepress-blog/assets/js/37.37735106.js"><link rel="prefetch" href="/vuepress-blog/assets/js/38.45a9e8b8.js"><link rel="prefetch" href="/vuepress-blog/assets/js/39.0fcd7dcc.js"><link rel="prefetch" href="/vuepress-blog/assets/js/4.ecf7f9e8.js"><link rel="prefetch" href="/vuepress-blog/assets/js/40.621682ab.js"><link rel="prefetch" href="/vuepress-blog/assets/js/41.d03d4354.js"><link rel="prefetch" href="/vuepress-blog/assets/js/42.edf41024.js"><link rel="prefetch" href="/vuepress-blog/assets/js/43.8cd60945.js"><link rel="prefetch" href="/vuepress-blog/assets/js/44.de2cd4e9.js"><link rel="prefetch" href="/vuepress-blog/assets/js/45.4fb41246.js"><link rel="prefetch" href="/vuepress-blog/assets/js/46.b26d762d.js"><link rel="prefetch" href="/vuepress-blog/assets/js/47.3bb572d2.js"><link rel="prefetch" href="/vuepress-blog/assets/js/48.dc6af168.js"><link rel="prefetch" href="/vuepress-blog/assets/js/49.9511edba.js"><link rel="prefetch" href="/vuepress-blog/assets/js/5.8cea2090.js"><link rel="prefetch" href="/vuepress-blog/assets/js/50.2e05304d.js"><link rel="prefetch" href="/vuepress-blog/assets/js/51.f72b0b54.js"><link rel="prefetch" href="/vuepress-blog/assets/js/52.1650a6e6.js"><link rel="prefetch" href="/vuepress-blog/assets/js/53.36c638aa.js"><link rel="prefetch" href="/vuepress-blog/assets/js/54.5931bcf4.js"><link rel="prefetch" href="/vuepress-blog/assets/js/55.f48c6b88.js"><link rel="prefetch" href="/vuepress-blog/assets/js/56.6d799974.js"><link rel="prefetch" href="/vuepress-blog/assets/js/57.0abda071.js"><link rel="prefetch" href="/vuepress-blog/assets/js/58.e4e2e95d.js"><link rel="prefetch" href="/vuepress-blog/assets/js/59.fc9cc726.js"><link rel="prefetch" href="/vuepress-blog/assets/js/6.5b653d91.js"><link rel="prefetch" href="/vuepress-blog/assets/js/60.d0cdc48d.js"><link rel="prefetch" href="/vuepress-blog/assets/js/61.e663cede.js"><link rel="prefetch" href="/vuepress-blog/assets/js/62.1b3ef15b.js"><link rel="prefetch" href="/vuepress-blog/assets/js/63.b17e2bda.js"><link rel="prefetch" href="/vuepress-blog/assets/js/64.3b7bc255.js"><link rel="prefetch" href="/vuepress-blog/assets/js/65.bb24c420.js"><link rel="prefetch" href="/vuepress-blog/assets/js/7.fcec5877.js"><link rel="prefetch" href="/vuepress-blog/assets/js/vendors~docsearch.a0f89813.js">
    <link rel="stylesheet" href="/vuepress-blog/assets/css/0.styles.631b7830.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vuepress-blog/" class="home-link router-link-active"><!----> <span class="site-name">Happyblog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vuepress-blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/vuepress-blog/miniVue2/" class="nav-link">
  mini-Vue2 文档
</a></div><div class="nav-item"><a href="/vuepress-blog/performance/" class="nav-link">
  性能优化
</a></div><div class="nav-item"><a href="/vuepress-blog/chat/" class="nav-link router-link-active">
  前端杂谈
</a></div><div class="nav-item"><a href="https://github.com/Nwu23787/mini-Vue2" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vuepress-blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/vuepress-blog/miniVue2/" class="nav-link">
  mini-Vue2 文档
</a></div><div class="nav-item"><a href="/vuepress-blog/performance/" class="nav-link">
  性能优化
</a></div><div class="nav-item"><a href="/vuepress-blog/chat/" class="nav-link router-link-active">
  前端杂谈
</a></div><div class="nav-item"><a href="https://github.com/Nwu23787/mini-Vue2" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>前端杂谈</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuepress-blog/chat/浏览器指纹.html" class="sidebar-link">浏览器指纹</a></li><li><a href="/vuepress-blog/chat/浏览器中 ESModule 的工作原理.html" class="sidebar-link">浏览器中 ESModule 的工作原理</a></li><li><a href="/vuepress-blog/chat/浏览器中的事件循环.html" class="sidebar-link">浏览器中的事件循环</a></li><li><a href="/vuepress-blog/chat/资源提示符.html" class="sidebar-link">资源提示符</a></li><li><a href="/vuepress-blog/chat/node模块查找策略.html" class="sidebar-link">node模块查找策略</a></li><li><a href="/vuepress-blog/chat/requestAnimationFrame.html" class="sidebar-link">requestAnimationFrame</a></li><li><a href="/vuepress-blog/chat/WebView 入门.html" class="sidebar-link">WebView 入门</a></li><li><a href="/vuepress-blog/chat/CSS 属性值的计算.html" class="sidebar-link">CSS 属性值的计算</a></li><li><a href="/vuepress-blog/chat/浏览器渲染原理.html" class="active sidebar-link">浏览器渲染原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress-blog/chat/浏览器渲染原理.html#渲染" class="sidebar-link">渲染</a></li><li class="sidebar-sub-header"><a href="/vuepress-blog/chat/浏览器渲染原理.html#解析-html" class="sidebar-link">解析 HTML</a></li><li class="sidebar-sub-header"><a href="/vuepress-blog/chat/浏览器渲染原理.html#样式计算" class="sidebar-link">样式计算</a></li><li class="sidebar-sub-header"><a href="/vuepress-blog/chat/浏览器渲染原理.html#布局" class="sidebar-link">布局</a></li><li class="sidebar-sub-header"><a href="/vuepress-blog/chat/浏览器渲染原理.html#分层" class="sidebar-link">分层</a></li><li class="sidebar-sub-header"><a href="/vuepress-blog/chat/浏览器渲染原理.html#生成绘制指令" class="sidebar-link">生成绘制指令</a></li><li class="sidebar-sub-header"><a href="/vuepress-blog/chat/浏览器渲染原理.html#分块" class="sidebar-link">分块</a></li><li class="sidebar-sub-header"><a href="/vuepress-blog/chat/浏览器渲染原理.html#光栅化" class="sidebar-link">光栅化</a></li><li class="sidebar-sub-header"><a href="/vuepress-blog/chat/浏览器渲染原理.html#绘制" class="sidebar-link">绘制</a></li><li class="sidebar-sub-header"><a href="/vuepress-blog/chat/浏览器渲染原理.html#总结" class="sidebar-link">总结</a></li><li class="sidebar-sub-header"><a href="/vuepress-blog/chat/浏览器渲染原理.html#参考资料-推荐阅读" class="sidebar-link">参考资料&amp;推荐阅读</a></li></ul></li><li><a href="/vuepress-blog/chat/跨标签页通信的方案与实践（上）.html" class="sidebar-link">跨标签页通信的方案与实践（上）</a></li><li><a href="/vuepress-blog/chat/跨标签页通信的方案与实践（下）.html" class="sidebar-link">跨标签页通信的方案与实践（下）</a></li><li><a href="/vuepress-blog/chat/Web Worker 简介.html" class="sidebar-link">Web Worker 简介</a></li><li><a href="/vuepress-blog/chat/渲染中的分层与合成.html" class="sidebar-link">渲染中的分层与合成</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="浏览器渲染原理"><a href="#浏览器渲染原理" class="header-anchor">#</a> 浏览器渲染原理</h1> <h2 id="渲染"><a href="#渲染" class="header-anchor">#</a> 渲染</h2> <p>所谓的渲染，就是通过 HTML 文件，计算出页面上每一个像素点的颜色。</p> <p>当我们在浏览器地址栏输入一个 URL 之后，回车，就会出现一个页面，这个过程，我们可以拆分为网络和渲染两部分。</p> <p>网络部分其实就是通过 http 请求，拿到 HTML 文件的过程。这里我们主要说渲染过程。</p> <p>在<strong>网络进程</strong>拿到 HTML 文件之后，他会将 HTML 文件<strong>包装成一个渲染任务</strong>，<strong>加入到消息队列</strong>中。之后，在<strong>事件循环</strong>机制的作用下，JS 主线程（也就是渲染主线程）会拿到这个任务，并开始执行。自此，<strong>渲染过程开始</strong>。</p> <img src="/vuepress-blog/assets/img/Snipaste_2024-08-01_11-45-06.9654638c.png" style="zoom:67%;"> <p>整个渲染流程可以分为 8 个阶段，分别是：</p> <ul><li>解析 HTML（HTML文件 --&gt; DOM 树 和 CSSOM 树）</li> <li>样式计算（DOM 树 和 CSSOM 树 --&gt; 渲染树）</li> <li>布局（渲染树 --&gt; 布局树）</li> <li>分层（布局树 -&gt; 图层）</li> <li>生成绘制指令（图层 -&gt; 绘制指令）</li> <li>分块（绘制指令 -&gt; 图层块）</li> <li>光栅化（图层块 -&gt; 位图）</li> <li>绘制（位图 -&gt; 最终渲染）</li></ul> <p>每一个阶段都有明确的输入和输出，上一个阶段的输出，会成为下一个阶段的输入</p> <h2 id="解析-html"><a href="#解析-html" class="header-anchor">#</a> 解析 HTML</h2> <p>渲染主线程开始执行渲染任务时，第一步就是解析 HTML 文件。本阶段的输入与输出：</p> <ul><li>输入：<strong>HTML 文件</strong></li> <li>输出：<strong>DOM 树 和 CSSOM 树</strong></li></ul> <img src="/vuepress-blog/assets/img/Snipaste_2024-08-01_12-50-49.73ae2191.png" style="zoom:50%;"> <p>之所以要将 HTML 文件处理成 DOM 树 和 CSSOM 树，主要是<strong>为了后续步骤的方便</strong>，操作一个超长的字符串肯定远远没有直接操作一个对象来的方便。同时，也<strong>开放了 JS 操作 DOM 树 和 CSSOM 树的能力</strong>。</p> <h3 id="处理-html"><a href="#处理-html" class="header-anchor">#</a> 处理 HTML</h3> <p>首先我们拿到的 HTML 文件，其实就是一个字符串。因为计算机之间的网络传输，实际上只能传输二进制字节码数据。浏览器接收到这些字节码数据之后，将其转换为字符串。</p> <img src="/vuepress-blog/assets/img/Snipaste_2024-08-01_12-46-54.f3a30bb2.png" style="zoom:67%;"> <p>拿到字符串之后，我们需要对字符串进行拆解，给每一个单元做上标记，也就是标记化。标记化的作用是为了理解每一个小的字符串单元的语义。</p> <img src="/vuepress-blog/assets/img/Snipaste_2024-08-01_12-53-32.63b4c311.png" style="zoom:67%;"> <p>标记化完成之后，我们就可以在此基础上构建出 DOM 树了。</p> <img src="/vuepress-blog/assets/img/Snipaste_2024-08-01_12-54-41.6439ccc2.png" style="zoom:67%;"> <h3 id="处理-css"><a href="#处理-css" class="header-anchor">#</a> 处理 CSS</h3> <p>在 HTML 文件中，有很多不同的样式表，常见的有：</p> <ul><li>内部样式（<code>&lt;style&gt;</code>）</li> <li>外部样式（<code>&lt;link&gt;</code>）</li> <li>内联样式表（<code>style=‘ ’</code>）</li></ul> <p>我们来看最终生成的 CSSOM 树的结构：</p> <img src="/vuepress-blog/assets/img/Snipaste_2024-08-01_13-13-19.40f8cb3b.png" style="zoom:67%;"> <p>根节点 StyleSheetList 是所有样式表的集合，根节点下的子节点 CSSStyleSheet 是各个不同的样式表，每个样式表中有多个 CSSStyleRule，也就是 CSS 选择器。每个选择器对象包含了选择器的名称和属性。</p> <p>CSS 的处理有一个特殊之处，在于 link 所对应的外链 CSS。我们都知道，link 标签下载和解析 CSS 不会阻塞 HTML 的解析和渲染，这是为什么呢。</p> <p>原来，为了提升 HTML 的解析效率，在开始解析 HTML 文件之前，浏览器会先开启一个<strong>预解析线程</strong>，该线程会快速浏览当前的 HTML 文件，将其中的外链 CSS 和 JS <strong>交给网络进程</strong>去下载。</p> <p>当渲染主线程解析到 link 标签时，不会等待 CSS 资源的下载和解析，而是直接继续向下解析 HTML 文件。</p> <img src="/vuepress-blog/assets/img/Snipaste_2024-08-01_13-22-42.943ca04a.png" style="zoom:67%;"> <p>当网络进程将 CSS 资源下载完成之后，会将 CSS 文件交给<strong>预解析线程进行解析</strong>，解析完成之后，再将结果交给渲染主线程。</p> <p>所以，CSS 的下载和解析不会阻塞 HTML 文件解析，因为他们<strong>根本不在同一个线程中</strong>！CSS 的下载在<strong>网络进程中</strong>执行，CSS 的解析由<strong>预解析线程</strong>执行，而 HTML 的解析由<strong>渲染主线程</strong>执行。</p> <h3 id="处理-js"><a href="#处理-js" class="header-anchor">#</a> 处理 JS</h3> <p>对于 JS 代码，尤其是外链的 JS 文件，我们在前面已经说过，会由预解析线程提前将下载任务交给网络进程去进行下载。</p> <p>但是，与 CSS 文件不同的是，预解析线程不能执行或处理 JS 文件。因为 JS 在设计之初就被设计成了单线程的语言，一般来说，同一时间，只能有一处地方在执行 JS 代码。而浏览器的多个线程中，只有渲染主线程可以执行 JS 代码。预解析线程不能，也没有能力去执行 JS 代码。</p> <p>所以，最终的 JS 文件，依然要交给渲染主线程去进行处理。</p> <p>另外，JS 和 CSS 相比还有一个独特的能力，那就是 JS 代码可以修改当前 DOM 树结构。所以，当渲染主线程解析到 <code>&lt;script&gt;</code> 标签时，必须停止解析，阻塞起来，等待当前 <code>&lt;script&gt;</code> 对应的 JS 资源下载完成，然后执行这个 JS 文件，执行完成之后，才可以继续向下解析 HTML 文件。</p> <p>所以，<strong>JS 的加载和执行都是会阻塞 HTML 文件的解析</strong>的：</p> <ul><li>加载阶段：虽然 JS 资源是在网络进程中下载的，但是渲染主线程必须阻塞起来，等待 JS 资源下载完成</li> <li>执行阶段：渲染主线程转而执行 JS 代码，线程被 JS 占用，无法继续解析 HTML 文件。</li></ul> <img src="/vuepress-blog/assets/img/Snipaste_2024-08-01_13-34-38.0aeb3110.png" style="zoom:67%;"> <p>所以说，如果想要首屏加载快，就<strong>不应该把 JS 文件放在 HTML 文件的头部</strong>。</p> <p>对于放在头部的 JS 文件，我们可以采用 <strong>defer</strong> 和 <strong>async</strong> 这两个资源提示符来避免主线程的阻塞。当主线程解析到含有 defer 和 async 的 script 标签时，<strong>不会阻塞等待 JS 资源的下载，而是继续向下解析 HTML 文件。</strong></p> <p>这两个资源提示符的差别在于 JS 文件的执行时机：</p> <ul><li><strong>async</strong> <strong>无法保证 JS 文件的执行顺序和时机</strong>，他的执行时机完全取决于 JS 文件何时下载完成，一旦下载完成，就会<strong>立即被执行</strong></li> <li><strong>defer</strong> <strong>可以保证 JS 文件的执行顺序</strong>，他会在 JS 文件下载完成，并且 HTML 文件已经解析完成，且该 <code>&lt;script&gt;</code> 前的所有 <code>&lt;script&gt;</code> 标签都已经被执行完成之后，才会执行。</li></ul> <h2 id="样式计算"><a href="#样式计算" class="header-anchor">#</a> 样式计算</h2> <p>样式计算过程，就是遍历每一个 DOM 树中的节点，分析这些节点受哪些样式规则的影响，它最终的样式应该是什么。本阶段的输入和输出为：</p> <ul><li>输入：<strong>DOM 树 和 CSSOM 树</strong></li> <li>输出：<strong>每个节点都带有样式规则的 DOM 树（渲染树）</strong></li></ul> <p>这个过程比较复杂，具体过程可以参阅之前的博客[《CSS 属性值的计算过程》](https://nwu23787.github.io/vuepress-blog/chat/CSS 属性值的计算.html)，这里我们简单说一次此过程的流程：</p> <ol><li>收集所有样式表中的样式规则</li> <li>根据来源和重要性，进行层叠排序</li> <li>对于排序相同的样式规则，比较其优先级</li> <li>对于没有声明值，或声明值为继承/默认值的属性，进行继承或赋予默认值。</li></ol> <p>在这个过程完成之后，也就是经过样式计算之后，我们可以得到一个带有样式规则的 DOM 树，也可以看做是 CSSOM 树 和 DOM 树合并之后的结果。</p> <img src="/vuepress-blog/assets/img/Snipaste_2024-08-01_14-17-48.febea27a.png" style="zoom:67%;"> <h2 id="布局"><a href="#布局" class="header-anchor">#</a> 布局</h2> <p>得到带有样式规则的 DOM 树之后，会进行布局过程。此阶段的输入输出为：</p> <ul><li>输入：<strong>带有样式规则的 DOM 树</strong></li> <li>输出：<strong>布局树</strong></li></ul> <p>在布局阶段，浏览器会遍历 DOM 树的每一个节点，根据节点上的 CSS 规则计算出每一个节点的几何信息，包括节点的宽、高和位置信息等。布局树上每个节点会有它在页面上的 <strong><em>x，y</em> 坐标</strong>以及<strong>盒子大小</strong>（<em>bounding box sizes</em>）的具体信息。</p> <img src="/vuepress-blog/assets/img/Snipaste_2024-08-01_14-42-20.14b68c63.png" style="zoom:80%;"> <p>另外，布局树中的每一个节点是一个 C++ 对象，JS 是获取不到的。我们只能间接的获取一些信息，比如 <code>document.body.clientWidth</code> 等等</p> <p>布局树中的每一个节点，最终都是要渲染到页面上的，所以，<strong>布局树中只含有可见的节点</strong>。例如设置了 <code>display: none</code> 的节点，在布局树中是不存在的。</p> <p>此外，我们知道，<strong>伪元素是不存在于 DOM 树中</strong>的，也无法使用 JS 获取和操作。但是，一个<strong>可见的伪元素是可以存在于布局树中的</strong>。</p> <h2 id="分层"><a href="#分层" class="header-anchor">#</a> 分层</h2> <p>分层就是将要绘制的页面划分为<strong>多个图层</strong>，是浏览器对页面的一种<strong>优化方式</strong>，因为用户会和页面进行交互，那么页面就可能会发生变化，在发生变化时，如果不分层，我们就需要重新渲染整个页面。</p> <p>本阶段的输入输出为：</p> <ul><li>输入：<strong>布局树</strong></li> <li>输出：<strong>分层结果</strong></li></ul> <p>分层的好处在于，当一个层发生变化之后，我们只需要对这个层做后续的处理，而<strong>不影响其他层</strong>。</p> <p>至于如何分层，每个浏览器的策略不同，我们不必关心。我们在编写代码的时候，也无法手动指定分层。</p> <p>但是，我们可以通过一些 CSS 属性，来影响浏览器的分层结果，至于最后是否分层，还是需要浏览器根据自身的策略去自行决策。</p> <p>可以影响分层结果的 CSS 属性：</p> <ul><li>z-index</li> <li>opacity</li> <li>transform</li> <li><strong>will-change</strong></li></ul> <p>也就是和堆叠上下文有关的属性，都可以在一定程度上影响浏览器的分层结果。</p> <p>其中，<strong>will-change 对浏览器分层结果的影响较大</strong>，也就是添加了 will-change 属性的元素，其被单独分为一层的可能性较大。</p> <p>will-change 会提前告知浏览器，该元素的哪一个属性会改变，从而让浏览器提前做好优化的准备，例如分层。下面我们来举个例子，对于这样一个 HTML 页面：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>main<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Lorem.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Ullam.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 省略一百个p标签--&gt;</span>
        ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>我们可以在浏览器控制台的图层工具中看到分层结果：</p> <img src="/vuepress-blog/assets/img/Snipaste_2024-08-01_22-16-55.502e1f48.png" style="zoom:50%;"> <p>可以看到，这个 HTML 页面被浏览器分为了两层，其中 <code>#19</code> 这一层，其实是侧面的滚动条。因为滚动条的位置经常变化，所以经常被单独设为一层。</p> <p>如果我们希望将 <code>.main</code> 盒子单独设置为一层，那么我们可以尝试使用 will-change 去改变浏览器的分层结果：</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">.main</span><span class="token punctuation">{</span>
    <span class="token property">will-change</span><span class="token punctuation">:</span>opacity
<span class="token punctuation">}</span>
</code></pre></div><p>此时我们再查看分层结果，可以看到，<code>.main</code> 盒子已经被单独设置为了一层。</p> <img src="data:image/png;base64,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" style="zoom:80%;"> <h2 id="生成绘制指令"><a href="#生成绘制指令" class="header-anchor">#</a> 生成绘制指令</h2> <p>分层工作结束之后，主线程会为每个层生成绘制指令集，指令集用于描述这层的内容如何绘制出来。</p> <p>本阶段的输入输出为：</p> <ul><li>输入：<strong>分层结果</strong></li> <li>输出：<strong>绘制指令集</strong></li></ul> <img src="/vuepress-blog/assets/img/Snipaste_2024-08-02_09-34-34.a553a83a.png" style="zoom:67%;"> <p>生成的绘制指令类似于 canvas ：</p> <div class="language-js extra-class"><pre class="language-js"><code>context<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 开始路径</span>
context<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 移动画笔</span>
context<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 绘画出一条直线</span>
context<span class="token punctuation">.</span><span class="token function">closePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 闭合路径</span>
context<span class="token punctuation">.</span><span class="token function">stroke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 进行勾勒</span>
</code></pre></div><p>此过程只是生成了绘制指令，并没有执行这些指令。</p> <p>在生成绘制指令之后，<strong>主线程就不再参与页面的渲染了</strong>，而是交给其他线程去进行后续出来，其中比较重要的就是合成线程。</p> <img src="/vuepress-blog/assets/img/Snipaste_2024-08-02_09-45-36.114d9560.png" style="zoom:67%;"> <h2 id="分块"><a href="#分块" class="header-anchor">#</a> 分块</h2> <p>生成绘制指令后，渲染主线程将绘制指令交给合成线程。<strong>合成线程是渲染进程中的一个线程</strong>，合成线程会根据绘制指令，将每一个图层进行分块。</p> <img src="/vuepress-blog/assets/img/Snipaste_2024-08-02_10-00-08.813a7d8f.png" style="zoom:67%;"> <p>分块的主要目的是为了区分不同区域绘制时的<strong>优先级</strong>。比如在视口内或靠近视口的块，我们可以优先绘制。而不在视口内的块或距离视口较远的块，在绘制时的优先级就低。</p> <p>分块并不是合成线程亲力亲为的，合成线程会开启多个分块线程，同时进行分块操作。</p> <img src="/vuepress-blog/assets/img/Snipaste_2024-08-02_10-00-08.813a7d8f.png" style="zoom:67%;"> <h2 id="光栅化"><a href="#光栅化" class="header-anchor">#</a> 光栅化</h2> <p>光栅化就是将每一个块变成位图，或者是就是计算出块中每一个像素点的颜色。</p> <p>此阶段的输入输出：</p> <ul><li>输入：<strong>图层块</strong></li> <li>输出：<strong>位图</strong></li></ul> <img src="/vuepress-blog/assets/img/Snipaste_2024-08-02_10-25-02.544de389.png" style="zoom:67%;"> <p>光栅化并不是由合成线程完成的，而是提交给 <strong>GPU</strong> 来完成的，因为 GPU 的运算速度快。</p> <img src="/vuepress-blog/assets/img/Snipaste_2024-08-02_10-27-03.d39cf727.png" style="zoom:67%;"> <p>GPU 会同时开启多个线程来处理光栅化，并优先处理靠近视口的图层块（这样就是为什么上一步要进行分层）。处理完成之后，会将所有的位图信息返回给合成线程。</p> <img src="/vuepress-blog/assets/img/Snipaste_2024-08-02_10-31-55.68521201.png" style="zoom:67%;"> <h2 id="绘制"><a href="#绘制" class="header-anchor">#</a> 绘制</h2> <p>合成线程拿到所有的位图之后，会计算出所有的位图<strong>相对于屏幕的位置</strong>（之前我们计算的位置都是相对于页面而言的），生成指引信息。生成指引信息之后，合成线程会把这些指引信息交给 GPU 进程，由 GPU 进程调用硬件渲染页面。</p> <img src="/vuepress-blog/assets/img/Snipaste_2024-08-02_10-40-52.1250418e.png" style="zoom:50%;"> <p>在计算位图的位置时，还会考虑到 transform 变换。正因为 transform 在最后一个<strong>绘制阶段</strong>才被处理，而且并<strong>不由渲染主线程处理</strong>，所以效率才会高，无论渲染主线程如何忙碌，都不会影响 transform 。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p><img src="/vuepress-blog/assets/img/Snipaste_2024-08-02_11-20-02.01b51dcd.png" alt=""></p> <ul><li><strong>解析 HTML：<strong>网络进程将 HTML 文件交给</strong>渲染主线程</strong>，主线程解析 HTML 文件，解析开始前启动一个<strong>预解析线程</strong>，提前加载外链 JS 和外链 CSS。最终将 HTML 文件解析成 <strong>DOM 树</strong>和 <strong>CSSOM 树</strong>。</li> <li><strong>计算样式：<strong>渲染主线程通过</strong>层叠</strong>、<strong>继承和默认值</strong>两个过程，计算出每个 DOM 节点的最终样式，合并到 DOM 树上，最终生成<strong>渲染树</strong>（带有 样式规则的 CSSOM 树）</li> <li><strong>布局：<strong>渲染主线程根据渲染树，计算出每个元素的宽高、位置等布局信息，生成一颗</strong>布局树</strong>，布局树中<strong>只含有可见元素</strong>。</li> <li><strong>分层：<strong>渲染主线程根据布局树，将页面分为</strong>多个图层</strong>，每个图层之间互不影响。一个图层发生变化，只需要对这个图层做后续的处理，而不影响其他图层。</li> <li><strong>生成绘制指令：<strong>渲染主线程为每一个图层生成对应的</strong>绘制指令</strong>，并将这些绘制指令<strong>交给合成线程</strong>。</li> <li><strong>分块：<strong>合成线程根据 绘制指令，将页面</strong>分块</strong>。分块的目的是为了确定渲染时的<strong>优先级</strong>，在渲染时，靠近视口的块会优先渲染。</li> <li><strong>光栅化：<strong>合成线程将分好的图层块交给 GPU 进程，GPU 进程调用多个线程进行</strong>位图计算</strong>，计算完成之后，将位图传递回合成线程。</li> <li><strong>绘制：<strong>合成线程根据位图，计算位图</strong>相对于屏幕的位置</strong>，并生成<strong>指引信息</strong>。并将指引信息传递给 GPU 进程，GPU 进程再调用硬件进行页面渲染。</li></ul> <h2 id="参考资料-推荐阅读"><a href="#参考资料-推荐阅读" class="header-anchor">#</a> 参考资料&amp;推荐阅读</h2> <ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/Performance/How_browsers_work#%E6%B8%B2%E6%9F%93" target="_blank" rel="noopener noreferrer">渲染页面：浏览器的工作原理 - Web 性能 | MDN (mozilla.org)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/Performance/Critical_rendering_path" target="_blank" rel="noopener noreferrer">关键渲染路径 - Web 性能 | MDN (mozilla.org)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/vuepress-blog/chat/CSS 属性值的计算.html" class="prev">
        CSS 属性值的计算
      </a></span> <span class="next"><a href="/vuepress-blog/chat/跨标签页通信的方案与实践（上）.html">
        跨标签页通信的方案与实践（上）
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/vuepress-blog/assets/js/app.f8677ea4.js" defer></script><script src="/vuepress-blog/assets/js/2.32f56e5c.js" defer></script><script src="/vuepress-blog/assets/js/1.a930a345.js" defer></script><script src="/vuepress-blog/assets/js/11.8f72b06d.js" defer></script>
  </body>
</html>
