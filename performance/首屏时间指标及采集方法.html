<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>白屏/首屏时间指标及采集 | Happyblog</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="基于 vuepress 的简易博客平台">
    
    <link rel="preload" href="/vuepress-blog/assets/css/0.styles.631b7830.css" as="style"><link rel="preload" href="/vuepress-blog/assets/js/app.f8677ea4.js" as="script"><link rel="preload" href="/vuepress-blog/assets/js/2.32f56e5c.js" as="script"><link rel="preload" href="/vuepress-blog/assets/js/1.a930a345.js" as="script"><link rel="preload" href="/vuepress-blog/assets/js/16.7a561afc.js" as="script"><link rel="prefetch" href="/vuepress-blog/assets/js/10.ab76fc9b.js"><link rel="prefetch" href="/vuepress-blog/assets/js/11.8f72b06d.js"><link rel="prefetch" href="/vuepress-blog/assets/js/12.428f6f98.js"><link rel="prefetch" href="/vuepress-blog/assets/js/13.eb47b2b6.js"><link rel="prefetch" href="/vuepress-blog/assets/js/14.7257e695.js"><link rel="prefetch" href="/vuepress-blog/assets/js/15.bd1b03c3.js"><link rel="prefetch" href="/vuepress-blog/assets/js/17.cd516f79.js"><link rel="prefetch" href="/vuepress-blog/assets/js/18.42e9f2b1.js"><link rel="prefetch" href="/vuepress-blog/assets/js/19.4958156f.js"><link rel="prefetch" href="/vuepress-blog/assets/js/20.cd1f9a1c.js"><link rel="prefetch" href="/vuepress-blog/assets/js/21.e4fea2d1.js"><link rel="prefetch" href="/vuepress-blog/assets/js/22.0919633c.js"><link rel="prefetch" href="/vuepress-blog/assets/js/23.331c698f.js"><link rel="prefetch" href="/vuepress-blog/assets/js/24.5874fb5a.js"><link rel="prefetch" href="/vuepress-blog/assets/js/25.e56a5813.js"><link rel="prefetch" href="/vuepress-blog/assets/js/26.7e912fb0.js"><link rel="prefetch" href="/vuepress-blog/assets/js/27.aa11be6f.js"><link rel="prefetch" href="/vuepress-blog/assets/js/28.b8505e46.js"><link rel="prefetch" href="/vuepress-blog/assets/js/29.155d9866.js"><link rel="prefetch" href="/vuepress-blog/assets/js/3.d7d8640a.js"><link rel="prefetch" href="/vuepress-blog/assets/js/30.80297b92.js"><link rel="prefetch" href="/vuepress-blog/assets/js/31.977ccbdd.js"><link rel="prefetch" href="/vuepress-blog/assets/js/32.767609f9.js"><link rel="prefetch" href="/vuepress-blog/assets/js/33.44891ea8.js"><link rel="prefetch" href="/vuepress-blog/assets/js/34.f516ab0b.js"><link rel="prefetch" href="/vuepress-blog/assets/js/35.151a5daf.js"><link rel="prefetch" href="/vuepress-blog/assets/js/36.ece446f9.js"><link rel="prefetch" href="/vuepress-blog/assets/js/37.37735106.js"><link rel="prefetch" href="/vuepress-blog/assets/js/38.45a9e8b8.js"><link rel="prefetch" href="/vuepress-blog/assets/js/39.0fcd7dcc.js"><link rel="prefetch" href="/vuepress-blog/assets/js/4.ecf7f9e8.js"><link rel="prefetch" href="/vuepress-blog/assets/js/40.621682ab.js"><link rel="prefetch" href="/vuepress-blog/assets/js/41.d03d4354.js"><link rel="prefetch" href="/vuepress-blog/assets/js/42.edf41024.js"><link rel="prefetch" href="/vuepress-blog/assets/js/43.8cd60945.js"><link rel="prefetch" href="/vuepress-blog/assets/js/44.de2cd4e9.js"><link rel="prefetch" href="/vuepress-blog/assets/js/45.4fb41246.js"><link rel="prefetch" href="/vuepress-blog/assets/js/46.b26d762d.js"><link rel="prefetch" href="/vuepress-blog/assets/js/47.3bb572d2.js"><link rel="prefetch" href="/vuepress-blog/assets/js/48.dc6af168.js"><link rel="prefetch" href="/vuepress-blog/assets/js/49.9511edba.js"><link rel="prefetch" href="/vuepress-blog/assets/js/5.8cea2090.js"><link rel="prefetch" href="/vuepress-blog/assets/js/50.2e05304d.js"><link rel="prefetch" href="/vuepress-blog/assets/js/51.f72b0b54.js"><link rel="prefetch" href="/vuepress-blog/assets/js/52.1650a6e6.js"><link rel="prefetch" href="/vuepress-blog/assets/js/53.36c638aa.js"><link rel="prefetch" href="/vuepress-blog/assets/js/54.5931bcf4.js"><link rel="prefetch" href="/vuepress-blog/assets/js/55.f48c6b88.js"><link rel="prefetch" href="/vuepress-blog/assets/js/56.6d799974.js"><link rel="prefetch" href="/vuepress-blog/assets/js/57.0abda071.js"><link rel="prefetch" href="/vuepress-blog/assets/js/58.e4e2e95d.js"><link rel="prefetch" href="/vuepress-blog/assets/js/59.fc9cc726.js"><link rel="prefetch" href="/vuepress-blog/assets/js/6.5b653d91.js"><link rel="prefetch" href="/vuepress-blog/assets/js/60.d0cdc48d.js"><link rel="prefetch" href="/vuepress-blog/assets/js/61.e663cede.js"><link rel="prefetch" href="/vuepress-blog/assets/js/62.1b3ef15b.js"><link rel="prefetch" href="/vuepress-blog/assets/js/63.b17e2bda.js"><link rel="prefetch" href="/vuepress-blog/assets/js/64.3b7bc255.js"><link rel="prefetch" href="/vuepress-blog/assets/js/65.bb24c420.js"><link rel="prefetch" href="/vuepress-blog/assets/js/7.fcec5877.js"><link rel="prefetch" href="/vuepress-blog/assets/js/vendors~docsearch.a0f89813.js">
    <link rel="stylesheet" href="/vuepress-blog/assets/css/0.styles.631b7830.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vuepress-blog/" class="home-link router-link-active"><!----> <span class="site-name">Happyblog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vuepress-blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/vuepress-blog/miniVue2/" class="nav-link">
  mini-Vue2 文档
</a></div><div class="nav-item"><a href="/vuepress-blog/performance/" class="nav-link router-link-active">
  性能优化
</a></div><div class="nav-item"><a href="/vuepress-blog/chat/" class="nav-link">
  前端杂谈
</a></div><div class="nav-item"><a href="https://github.com/Nwu23787/mini-Vue2" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vuepress-blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/vuepress-blog/miniVue2/" class="nav-link">
  mini-Vue2 文档
</a></div><div class="nav-item"><a href="/vuepress-blog/performance/" class="nav-link router-link-active">
  性能优化
</a></div><div class="nav-item"><a href="/vuepress-blog/chat/" class="nav-link">
  前端杂谈
</a></div><div class="nav-item"><a href="https://github.com/Nwu23787/mini-Vue2" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>前端性能优化</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuepress-blog/performance/前端性能优化的关键指标.html" class="sidebar-link">前端性能优化的关键指标</a></li><li><a href="/vuepress-blog/performance/页面加载全过程的优化策略分析.html" class="sidebar-link">页面加载全过程的优化策略分析</a></li><li><a href="/vuepress-blog/performance/首屏时间指标及采集方法.html" class="active sidebar-link">首屏时间指标及采集方法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress-blog/performance/首屏时间指标及采集方法.html#首屏时间相关指标" class="sidebar-link">首屏时间相关指标</a></li><li class="sidebar-sub-header"><a href="/vuepress-blog/performance/首屏时间指标及采集方法.html#首屏时间的手动采集" class="sidebar-link">首屏时间的手动采集</a></li><li class="sidebar-sub-header"><a href="/vuepress-blog/performance/首屏时间指标及采集方法.html#自动化采集首屏时间" class="sidebar-link">自动化采集首屏时间</a></li><li class="sidebar-sub-header"><a href="/vuepress-blog/performance/首屏时间指标及采集方法.html#附-传统性能指标-performance" class="sidebar-link">附：传统性能指标 Performance</a></li></ul></li><li><a href="/vuepress-blog/performance/其他性能指标的采集方法.html" class="sidebar-link">其他性能指标的采集方法</a></li><li><a href="/vuepress-blog/performance/仿渐进式图片优化首屏时间.html" class="sidebar-link">仿渐进式图片优化首屏时间</a></li><li><a href="/vuepress-blog/performance/performance与performanceObserver的对比与实践.html" class="sidebar-link">performance与performanceObserver的对比与实践</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="白屏-首屏时间指标及采集"><a href="#白屏-首屏时间指标及采集" class="header-anchor">#</a> 白屏/首屏时间指标及采集</h1> <h2 id="首屏时间相关指标"><a href="#首屏时间相关指标" class="header-anchor">#</a> 首屏时间相关指标</h2> <h3 id="fp-first-paint"><a href="#fp-first-paint" class="header-anchor">#</a> FP（First Paint）</h3> <p>页面上渲染出第一个像素点的时间，一般在 HTML 解析完成或者解析了一部分之后触发，FP 事件触发时间可以任务就是<strong>白屏时间</strong>。</p> <h3 id="fcp-first-contentful-paint"><a href="#fcp-first-contentful-paint" class="header-anchor">#</a> FCP（First Contentful Paint）</h3> <p>首次内容绘制，即浏览器中<strong>第一个内容被渲染完成</strong>的时间点，这个内容可以是文本、图片等等。良好的FCP应该控制在1.8s内。</p> <h3 id="fmp-first-meaningful-paint"><a href="#fmp-first-meaningful-paint" class="header-anchor">#</a> <strong>FMP</strong>（First Meaningful Paint）</h3> <p>有意义的内容被首次绘制出的时间，但是 “有意义” 的内容没有一个统一的标准，所以此指标并不常用。根据 MDN 的说法，<strong>FMP 已被弃用</strong>，取而代之的是LCP。<a href="https://developer.mozilla.org/en-US/docs/Glossary/First_meaningful_paint" target="_blank" rel="noopener noreferrer">First Meaningful Paint - MDN Web Docs Glossary: Definitions of Web-related terms | MDN (mozilla.org)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="lcp-largest-contentful-paint"><a href="#lcp-largest-contentful-paint" class="header-anchor">#</a> LCP（Largest Contentful Paint）</h3> <p>从页面开始加载到最大内容元素加载完成的时间。<a href="https://w3c.github.io/largest-contentful-paint/" target="_blank" rel="noopener noreferrer">最大的内容涂料 (w3c.github.io)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="dcl-domcontentloaded"><a href="#dcl-domcontentloaded" class="header-anchor">#</a> DCL（DOMContentLoaded ）</h3> <p>当 HTML 文档完全解析，且所有延迟脚本下载和执行完毕后，会触发 <strong><code>DOMContentLoaded</code></strong> 事件。它不会等待图片、子框架和异步脚本等其他内容完成加载。</p> <h3 id="l-onload"><a href="#l-onload" class="header-anchor">#</a> L（onLoad）</h3> <p>DOM 解析并渲染完成的时间。</p> <p>一般来说，我们可以认为：</p> <ol><li><strong>白屏时间 = FP</strong></li> <li><strong>首屏时间 = FCP</strong></li></ol> <h2 id="首屏时间的手动采集"><a href="#首屏时间的手动采集" class="header-anchor">#</a> 首屏时间的手动采集</h2> <p>手动采集首屏时间，一般来说是通过<strong>埋点</strong>的方式进行的。根据不同的业务需求，我们打上不同的点。例如：</p> <ol><li>对于淘宝商品详情页，首屏包含商品首图、商品信息、购物车等，我们就可以在这些内容加载完毕的地方打上点</li> <li>对应抖音直播页面，主要的核心内容是直播框，我们就可以在直播框加载完成的位置打上点</li></ol> <p>通过获取页面开始加载时间和我们自定义的结束位置时间，我们可以计算差值来获取首屏时间。</p> <p>手动采集和业务需求绑定，并不通用，但<strong>个性化较强</strong>。</p> <h2 id="自动化采集首屏时间"><a href="#自动化采集首屏时间" class="header-anchor">#</a> 自动化采集首屏时间</h2> <p>自动化采集首屏时间，是通过引入一段通用的代码来做首屏时间来自动化采集。引入过程中除了一些必要的配置，不需要做其他的事情。</p> <p>缺点在于无法满足某些个性化需求。</p> <h3 id="服务端渲染应用采集方法"><a href="#服务端渲染应用采集方法" class="header-anchor">#</a> 服务端渲染应用采集方法</h3> <p>首先我们需要知道页面渲染的过程：</p> <p><img src="/vuepress-blog/assets/img/8920240715161821.ae1b6922.png" alt=""></p> <p>对于服务端渲染来说，HTML文档加载并解析完成的时间点就是首屏时间。采集这个时间点，我们可以采用浏览器提供的  <strong>DOMContentLoaded</strong> API 来实现，在 chrome 的调试工具中我们可以看到 DOMContentLoaded 的具体数值</p> <p><img src="/vuepress-blog/assets/img/Snipaste_2024-07-15_16-49-03.d3000fcf.png" alt=""></p> <p>当页面中的元素被加载和解析完成之后，就会触发 DOMContentLoaded 事件，我们可以记录下此时的时间，减去页面初始化的时间 fetchStart 即可获取到首屏时间。</p> <p><img src="/vuepress-blog/assets/img/1213220240715173718.227dbfa4.png" alt=""></p> <ul><li><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Document/DOMContentLoaded_event" target="_blank" rel="noopener noreferrer">Document：DOMContentLoaded 事件 - Web API | MDN (mozilla.org)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/PerformanceTiming/fetchStart" target="_blank" rel="noopener noreferrer">PerformanceTiming.fetchStart - Web API | MDN (mozilla.org)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li></ul> <h3 id="单页面应用的采集方法"><a href="#单页面应用的采集方法" class="header-anchor">#</a> 单页面应用的采集方法</h3> <h4 id="单页面应用是否可以使用-performance-计算"><a href="#单页面应用是否可以使用-performance-计算" class="header-anchor">#</a> 单页面应用是否可以使用 performance 计算</h4> <p>单页面应用是否可以使用 performance 计算？这点各个技术社区中存有争议，笔者并没有找到一个确切的答案，<strong>个人目前认为是不准确的</strong>。可以参考阿里云团队前端技术专家彭伟春在2018年 GMTC 大会上关于《大前端时代前端监控的最佳实践》的演讲（链接附在文末）。其中提到了对于某个 SPA 应用的进行首屏时间采集时，使用 performance API 采集到的首屏时间是 1106 ms，而实际的首屏时间却是 1976ms。</p> <p><img src="/vuepress-blog/assets/img/Snipaste_2024-07-15_17-46-21.ebc53f83.png" alt=""></p> <p>造成这一差异的原因可能是由于 SPA 单页面应用的特性，用户在请求页面时，会先加载 index.html 页面，加载完成之后，就会触发 DOMContentLoaded 和 load 事件，而此时页面只是空白页，根本不是真正的首屏时间。 在加载完成之后，会加载 js 脚本，并通过 Ajax 异步请求数据并渲染页面，此时首屏才算渲染完成。</p> <h4 id="fmp-lcp-度量-spa-应用的首屏时间"><a href="#fmp-lcp-度量-spa-应用的首屏时间" class="header-anchor">#</a> FMP/LCP 度量 SPA 应用的首屏时间</h4> <p>FMP 在上文中已经提到过，即页面上首次绘制出有意义的元素的时间。对于 SPA 应用来说，index.html 文件加载完成之后，由于页面完全空白，<strong>并没有任何有意义的元素被渲染出</strong>，所以并不会触发 FMP。当获取到异步请求的数据并渲染出有意义的元素之后，才会真正触发 FMP。所以使用 FMP 来计算 SPA 应用的首屏时间理论上来说是可行的。我们也可以将 FMP 理解为<strong>主要内容的可见时间</strong>。但 FMP 的 “有意义” 内容很难界定，该指标的定义依赖于特定于浏览器的实现细节，这意味着它<strong>无法标准化</strong>，并且<strong>尚未在所有网络浏览器中实现</strong>。</p> <p>LCP 是页面中最大元素被渲染出的时间，页面加载过程中的最大绘制很可能从用户的角度来看意味着一个有意义的事件，他的标准更加统一。FMP在 lighthouse 中已被弃用，目前 W3C 更加推荐开发者<strong>使用 LCP 去替代 FMP</strong>。</p> <h4 id="使用-mutationobserver-计算-spa-应用的首屏时间"><a href="#使用-mutationobserver-计算-spa-应用的首屏时间" class="header-anchor">#</a> 使用 MutationObserver 计算 SPA 应用的首屏时间</h4> <p>首先我们提出一个猜想，我们是否可以认为<strong>页面上元素增量最大的时间点就是页面主要元素被渲染出的时间点</strong>，即首屏时间。</p> <p>这种猜想看似合理，其实是不完善的。页面上的元素种类很多，有些元素并没有实际意义，也有些元素是不可见的，这些元素被渲染出来，对于首屏来说没有任何价值。正因如此，不同种类的元素应该有不同的权重，我们在考虑元素增量的时候，需要<strong>加权</strong>考虑。</p> <p>所以，在页面加载时，我们使用 MutationObserver 监控 DOM 元素的变化，当元素变化时，程序会标记变化的元素，同时记录此时的时间点和分数，存储到数组中。加载完毕之后，通过对所收集到的数据的分析，找出分数最大的时间点，即可认为该时间点为首屏时间。具体流程如下：</p> <p><img src="/vuepress-blog/assets/img/Snipaste_2024-07-15_19-13-42.8763b777.png" alt=""></p> <p>从图中我们可以看到，元素权重是和元素的层级相关联的，具体来说，<strong>层级越深的元素，其权重越大</strong>。究其原因，是因为越往内层的元素越接近真实的首屏内容，而越往外的元素，则更接近没有实际内容的框架层，如 body 等。</p> <ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/MutationObserver" target="_blank" rel="noopener noreferrer">MutationObserver - Web API | MDN (mozilla.org)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>相关代码：</p> <ol><li><p>初始化监听</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">initObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">supportTiming</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> time <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> performance<span class="token punctuation">.</span>timing<span class="token punctuation">.</span>fetchStart<span class="token punctuation">;</span>
        <span class="token keyword">let</span> bodyTarget <span class="token operator">=</span> document<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bodyTarget<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> score <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          score <span class="token operator">+=</span> <span class="token function">calculateScore</span><span class="token punctuation">(</span>bodyTarget<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token constant">SCORE_ITEMS</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            score<span class="token punctuation">,</span>
            <span class="token literal-property property">t</span><span class="token operator">:</span> time
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token constant">SCORE_ITEMS</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">score</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token literal-property property">t</span><span class="token operator">:</span> time
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>document<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">childList</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">subtree</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token string">&quot;complete&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>mark <span class="token operator">=</span> <span class="token string">'readyState'</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">calFinallScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
        <span class="token string">&quot;load&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>mark <span class="token operator">=</span> <span class="token string">'load'</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">calFinallScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token boolean">true</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
        <span class="token string">'beforeunload'</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>mark <span class="token operator">=</span> <span class="token string">'beforeunload'</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">calFinallScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token boolean">true</span>
      <span class="token punctuation">)</span>
      <span class="token keyword">const</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      <span class="token keyword">function</span> <span class="token function">listenTouchstart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">2000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          that<span class="token punctuation">.</span><span class="token function">calFinallScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>mark <span class="token operator">=</span> <span class="token string">'touch'</span><span class="token punctuation">;</span>
          window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'touchstart'</span><span class="token punctuation">,</span> listenTouchstart<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
        <span class="token string">'touchstart'</span><span class="token punctuation">,</span>
        listenTouchstart<span class="token punctuation">,</span>
        <span class="token boolean">true</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div></li> <li><p>计算分数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">calculateScore</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> tiers<span class="token punctuation">,</span> parentScore</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> score <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> tagName <span class="token operator">=</span> el<span class="token punctuation">.</span>tagName<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token string">&quot;SCRIPT&quot;</span> <span class="token operator">!==</span> tagName <span class="token operator">&amp;&amp;</span>
      <span class="token string">&quot;STYLE&quot;</span> <span class="token operator">!==</span> tagName <span class="token operator">&amp;&amp;</span>
      <span class="token string">&quot;META&quot;</span> <span class="token operator">!==</span> tagName <span class="token operator">&amp;&amp;</span>
      <span class="token string">&quot;HEAD&quot;</span> <span class="token operator">!==</span> tagName
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> childrenLen <span class="token operator">=</span> el<span class="token punctuation">.</span>children <span class="token operator">?</span> el<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>childrenLen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> childs <span class="token operator">=</span> el<span class="token punctuation">.</span>children<span class="token punctuation">,</span> len <span class="token operator">=</span> childrenLen <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> len <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> len<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          score <span class="token operator">+=</span> <span class="token function">calculateScore</span><span class="token punctuation">(</span>childs<span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">,</span> tiers <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> score <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>score <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>parentScore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>getBoundingClientRect <span class="token operator">&amp;&amp;</span> el<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>top <span class="token operator">&lt;</span> <span class="token constant">WH</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      score <span class="token operator">+=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> tiers<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> score<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>计算出首屏时间</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> fmps <span class="token operator">=</span> <span class="token function">getFmp</span><span class="token punctuation">(</span><span class="token constant">SCORE_ITEMS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> record <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> o <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> o <span class="token operator">&lt;</span> fmps<span class="token punctuation">.</span>length<span class="token punctuation">;</span> o<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fmps<span class="token punctuation">[</span>o<span class="token punctuation">]</span><span class="token punctuation">.</span>t <span class="token operator">&gt;=</span> fmps<span class="token punctuation">[</span>o <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> l <span class="token operator">=</span> fmps<span class="token punctuation">[</span>o<span class="token punctuation">]</span><span class="token punctuation">.</span>score <span class="token operator">-</span> fmps<span class="token punctuation">[</span>o <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>score<span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">!</span>record <span class="token operator">||</span> record<span class="token punctuation">.</span>rate <span class="token operator">&lt;=</span> l<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span>record <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">t</span><span class="token operator">:</span> fmps<span class="token punctuation">[</span>o<span class="token punctuation">]</span><span class="token punctuation">.</span>t<span class="token punctuation">,</span>
        <span class="token literal-property property">rate</span><span class="token operator">:</span> l<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h2 id="附-传统性能指标-performance"><a href="#附-传统性能指标-performance" class="header-anchor">#</a> 附：<strong>传统性能指标 Performance</strong></h2> <p>Performance 接口可以获取到当前页面中与性能相关的信息</p> <p><img src="/vuepress-blog/assets/img/Snipaste_2024-07-15_20-26-15.e124d01a.png" alt=""></p> <p><img src="/vuepress-blog/assets/img/Snipaste_2024-07-15_20-26-50.27a14327.png" alt=""></p> <p><strong>performance 参数解析</strong></p> <p><code>startTime</code>：有些浏览器实现为<code>navigationStart</code>，代表浏览器开始unload前一个页面文档的开始时间节点。比如我们当前正在浏览baidu.com，在地址栏输入google.com并回车，浏览器的执行动作依次为：unload当前文档（即baidu.com）-&gt;请求下一文档（即google.com）。navigationStart的值便是触发unload当前文档的时间节点。如果当前文档为空，则navigationStart的值等于fetchStart。</p> <p><code>redirectStart</code>和<code>redirectEnd</code>：如果页面是由redirect而来，则redirectStart和redirectEnd分别代表redirect开始和结束的时间节点；</p> <p><code>unloadEventStart</code>和<code>unloadEventEnd</code>：如果前一个文档和请求的文档是同一个域的，则unloadEventStart和unloadEventEnd分别代表浏览器unload前一个文档的开始和结束时间节点。否则两者都等于0；</p> <p><code>fetchStart</code>是指在浏览器发起任何请求之前的时间值。fetchStart 时代表浏览器已经做好了发起网络请求的准备。在fetchStart和domainLookupStart之间，浏览器会检查当前文档的缓存；</p> <p><code>domainLookupStart</code>和<code>domainLookupEnd</code>分别代表DNS查询的开始和结束时间节点。如果浏览器没有进行DNS查询（比如使用了cache），则两者的值都等于fetchStart；</p> <p><code>connectStart</code>和<code>connectEnd</code>分别代表TCP建立连接和连接成功的时间节点。如果浏览器没有进行TCP连接（比如使用持久化连接webscoket），则两者都等于domainLookupEnd；</p> <p><code>secureConnectionStart</code>：可选。如果页面使用HTTPS，它的值是安全连接握手之前的时刻。如果该属性不可用，则返回undefined。如果该属性可用，但没有使用HTTPS，则返回0；</p> <p><code>requestStart</code>代表浏览器发起请求的时间节点，请求的方式可以是请求服务器、缓存、本地资源等；</p> <p><code>responseStart</code>和<code>responseEnd</code>分别代表浏览器收到从服务器端（或缓存、本地资源）响应回的第一个字节和最后一个字节数据的时刻；</p> <p><code>domLoading</code>代表浏览器开始解析html文档的时间节点。我们知道IE浏览器下的document有readyState属性，domLoading的值就等于readyState改变为loading的时间节点；</p> <p><code>domInteractive</code>代表浏览器解析html文档的状态为interactive时的时间节点。domInteractive并非DOMReady，它早于DOMReady触发，代表html文档解析完毕（即dom tree创建完成）但是内嵌资源（比如外链css、js等）还未加载的时间点；</p> <p><code>domContentLoadedEventStart</code>：代表DOMContentLoaded事件触发的时间节点： 页面文档完全加载并解析完毕之后,会触发DOMContentLoaded事件，HTML文档不会等待样式文件,图片文件,子框架页面的加载(load事件可以用来检测HTML页面是否完全加载完毕(fully-loaded))。</p> <p><code>domContentLoadedEventEnd</code>：代表DOMContentLoaded事件完成的时间节点，此刻用户可以对页面进行操作，也就是jQuery中的domready时间；</p> <p><code>domComplete</code>：html文档完全解析完毕的时间节点；</p> <p><code>loadEventStart</code>和<code>loadEventEnd</code>分别代表onload事件触发和结束的时间节点</p> <p>参考资料：</p> <ol><li><p><a href="https://gmtc.infoq.cn/2018/beijing/presentation/643" target="_blank" rel="noopener noreferrer">GMTC北京2018_全球大前端技术大会_ - 前端时代前端监控的最佳实践<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://developer.aliyun.com/article/1493358" target="_blank" rel="noopener noreferrer">前端vite+vue3——可视化页面性能耗时指标（fmp、fp）-阿里云开发者社区 (aliyun.com)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://juejin.cn/post/6844904020482457613?searchId=202407181550392A59909693ED64A25642#heading-9" target="_blank" rel="noopener noreferrer">前端性能监控方案（首屏、白屏时间等） - 掘金 (juejin.cn)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/vuepress-blog/performance/页面加载全过程的优化策略分析.html" class="prev">
        页面加载全过程的优化策略分析
      </a></span> <span class="next"><a href="/vuepress-blog/performance/其他性能指标的采集方法.html">
        其他性能指标的采集方法
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/vuepress-blog/assets/js/app.f8677ea4.js" defer></script><script src="/vuepress-blog/assets/js/2.32f56e5c.js" defer></script><script src="/vuepress-blog/assets/js/1.a930a345.js" defer></script><script src="/vuepress-blog/assets/js/16.7a561afc.js" defer></script>
  </body>
</html>
